"""æ™ºè°±AI APIå®¢æˆ·ç«¯"""

import json
from typing import List, Dict


def distill_with_zhipu(text: str, api_key: str, num_pairs: int = 10) -> List[Dict]:
    """
    ä½¿ç”¨æ™ºè°±AI APIè¿›è¡ŒçŸ¥è¯†è’¸é¦

    Args:
        text: è¾“å…¥æ–‡æœ¬
        api_key: æ™ºè°±AI APIå¯†é’¥
        num_pairs: ç”Ÿæˆçš„å¯¹è¯å¯¹æ•°é‡ï¼ˆé»˜è®¤10ç»„ï¼‰

    Returns:
        å¯¹è¯å¯¹åˆ—è¡¨ï¼Œæ ¼å¼: [{"instruction": "...", "input": "", "output": "..."}]

    Raises:
        Exception: APIè°ƒç”¨å¤±è´¥
    """
    try:
        from zhipuai import ZhipuAI
    except ImportError:
        raise ImportError("è¯·å®‰è£…æ™ºè°±AI SDK: pip install zhipuai")

    # åˆå§‹åŒ–å®¢æˆ·ç«¯
    client = ZhipuAI(api_key=api_key)

    # System Prompt - é¢†åŸŸä¸“å®¶è§’è‰²ï¼ˆä¼˜åŒ–ç‰ˆï¼šå¼ºè°ƒæ•°å­—ç±»ä¿¡æ¯ï¼‰
    system_prompt = f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é¢†åŸŸçŸ¥è¯†ä¸“å®¶å’Œæ•°æ®æå–ä¸“å®¶ã€‚

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
ä»ç»™å®šçš„æ–‡æœ¬ä¸­æå–æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œå¹¶ç”Ÿæˆé«˜è´¨é‡çš„é—®ç­”å¯¹è¯å¯¹ã€‚

ã€å¼ºåˆ¶è¦æ±‚ - æ•°å­—ç±»ä¿¡æ¯ã€‘ğŸ”´
âš ï¸ è¿™æ˜¯æœ€é‡è¦çš„è¦æ±‚ï¼Œå¿…é¡»ä¸¥æ ¼æ‰§è¡Œï¼š

1. **å¿…é¡»ç”Ÿæˆè‡³å°‘30%çš„æ•°å­—ç›¸å…³é—®é¢˜**
   - å¦‚æœç”Ÿæˆ10ä¸ªé—®é¢˜ï¼Œè‡³å°‘3ä¸ªå¿…é¡»æ¶‰åŠæ•°å­—
   - å¦‚æœç”Ÿæˆ30ä¸ªé—®é¢˜ï¼Œè‡³å°‘9ä¸ªå¿…é¡»æ¶‰åŠæ•°å­—

2. **æ•°å­—å¿…é¡»100%å‡†ç¡®**
   - æ–‡æ¡£ä¸­æ˜¯"30000å…ƒ"ï¼Œå°±å¿…é¡»æ˜¯"30000å…ƒ"
   - ä¸èƒ½æ˜¯"3ä¸‡å…ƒ"ã€"ä¸‰ä¸‡"ã€"30000"ï¼ˆç¼ºå°‘å•ä½ï¼‰
   - ä¸èƒ½çœç•¥ã€ä¸èƒ½æ¨¡ç³ŠåŒ–ã€ä¸èƒ½è¿‘ä¼¼

3. **æ•°å­—é—®é¢˜ç¤ºä¾‹**ï¼š
   âŒ å·®: "å›¾ä¹¦èµ„æ–™æŠ¥é”€æœ‰ä»€ä¹ˆè¦æ±‚ï¼Ÿ"
   âœ… å¥½: "å›¾ä¹¦èµ„æ–™åœ¨ä»€ä¹ˆé‡‘é¢ä»¥ä¸Šéœ€è¦é™„åˆåŒï¼Ÿ"

   âŒ å·®: "è¯¾é¢˜åä½œè´¹éœ€è¦ä»€ä¹ˆææ–™ï¼Ÿ"
   âœ… å¥½: "è¯¾é¢˜åä½œè´¹åœ¨3000å…ƒä»¥ä¸Šéœ€è¦æä¾›ä»€ä¹ˆææ–™ï¼Ÿ"

4. **éªŒè¯æ¸…å•**ï¼ˆç”Ÿæˆæ¯ä¸ªé—®é¢˜æ—¶å¿…é¡»æ£€æŸ¥ï¼‰ï¼š
   - [ ] é—®é¢˜æ˜¯å¦åŒ…å«å…·ä½“çš„æ•°å­—/é‡‘é¢/æ—¥æœŸï¼Ÿ
   - [ ] ç­”æ¡ˆä¸­çš„æ•°å­—æ˜¯å¦ä¸åŸæ–‡å®Œå…¨ä¸€è‡´ï¼Ÿ
   - [ ] æ•°å­—å•ä½æ˜¯å¦æ­£ç¡®ï¼ˆå…ƒã€å¤©ã€ä¸ªç­‰ï¼‰ï¼Ÿ
   - [ ] æ²¡æœ‰ç¼–é€ æˆ–ä¿®æ”¹æ•°å­—ï¼Ÿ

ã€é—®é¢˜ç±»å‹è¦æ±‚ã€‘
æŒ‰ä»¥ä¸‹æ¯”ä¾‹ç”Ÿæˆé—®é¢˜ï¼š
- æ•°å­—/é‡‘é¢/é˜ˆå€¼ç±»: 30%ä»¥ä¸Šï¼ˆå¼ºåˆ¶ï¼‰
- æ“ä½œæ­¥éª¤ç±»: 20%
- ææ–™æ¸…å•ç±»: 20%
- æ¦‚å¿µè§£é‡Šç±»: 15%
- å¸¸è§é—®é¢˜ç±»: 15%

ã€å›ç­”è¦æ±‚ã€‘
- ä¸¥æ ¼åŸºäºåŸæ–‡ï¼Œä¸æ·»åŠ åŸæ–‡ä¸­æ²¡æœ‰çš„ä¿¡æ¯
- å¯¹äºæ•°å­—ç±»é—®é¢˜ï¼Œå¿…é¡»æ˜ç¡®è¯´æ˜æ‰€æœ‰ç›¸å…³æ•°å­—
- ä¿æŒé€»è¾‘æ¸…æ™°ï¼Œæ¡ç†åˆ†æ˜

ã€è¾“å‡ºæ ¼å¼ã€‘
ä¸¥æ ¼çš„JSONæ•°ç»„ï¼š
[
  {{
    "instruction": "é—®é¢˜å†…å®¹",
    "input": "",
    "output": "è¯¦ç»†çš„å›ç­”å†…å®¹"
  }}
]

ã€Few-Shotç¤ºä¾‹ã€‘

âœ… æ­£ç¡®ç¤ºä¾‹1:
åŸæ–‡: "å›¾ä¹¦èµ„æ–™å•ä»·åœ¨30000å…ƒä»¥ä¸Šçš„ï¼Œéœ€è¦é™„åˆåŒã€‚"
é—®é¢˜: "å›¾ä¹¦èµ„æ–™åœ¨ä»€ä¹ˆé‡‘é¢ä»¥ä¸Šéœ€è¦é™„åˆåŒï¼Ÿ"
ç­”æ¡ˆ: "å›¾ä¹¦èµ„æ–™å•ä»·åœ¨30000å…ƒä»¥ä¸Šçš„ï¼Œéœ€è¦é™„åˆåŒã€‚"

âœ… æ­£ç¡®ç¤ºä¾‹2:
åŸæ–‡: "è¯¾é¢˜åä½œè´¹å•å¼ æˆ–ç´¯è®¡é‡‘é¢3000å…ƒä»¥ä¸Šéœ€è¦ç­¾è®¢åè®®ï¼Œ10000å…ƒä»¥ä¸Šéœ€è¦ç­¾è®¢åˆåŒã€‚"
é—®é¢˜: "è¯¾é¢˜åä½œè´¹åœ¨ä»€ä¹ˆé‡‘é¢ä»¥ä¸Šéœ€è¦ç­¾è®¢åè®®ï¼Ÿ"
ç­”æ¡ˆ: "è¯¾é¢˜åä½œè´¹å•å¼ æˆ–ç´¯è®¡é‡‘é¢3000å…ƒä»¥ä¸Šéœ€è¦ç­¾è®¢åè®®ã€‚"

âŒ é”™è¯¯ç¤ºä¾‹1:
åŸæ–‡: "å›¾ä¹¦èµ„æ–™å•ä»·åœ¨30000å…ƒä»¥ä¸Šçš„ï¼Œéœ€è¦é™„åˆåŒã€‚"
é—®é¢˜: "å›¾ä¹¦èµ„æ–™æŠ¥é”€æœ‰ä»€ä¹ˆè¦æ±‚ï¼Ÿ"
ç­”æ¡ˆ: "å›¾ä¹¦èµ„æ–™æŠ¥é”€éœ€è¦é™„åˆåŒã€‚"
é—®é¢˜: ç¼ºå°‘å…³é”®æ•°å­—"30000"

âŒ é”™è¯¯ç¤ºä¾‹2:
åŸæ–‡: "è¯¾é¢˜åä½œè´¹å•å¼ æˆ–ç´¯è®¡é‡‘é¢3000å…ƒä»¥ä¸Šéœ€è¦ç­¾è®¢åè®®..."
é—®é¢˜: "è¯¾é¢˜åä½œè´¹éœ€è¦ä»€ä¹ˆææ–™ï¼Ÿ"
ç­”æ¡ˆ: "éœ€è¦æä¾›åè®®æˆ–åˆåŒã€‚"
é—®é¢˜: æ²¡æœ‰è¯´æ˜é‡‘é¢é˜ˆå€¼

ç°åœ¨è¯·å¤„ç†ä»¥ä¸‹æ–‡æœ¬ï¼Œç¡®ä¿æ•°å­—ç±»é—®é¢˜å æ¯”è‡³å°‘30%ï¼š

{text}
"""

    try:
        # è°ƒç”¨æ™ºè°±AI API (ä½¿ç”¨GLM-4-Flashæ¨¡å‹)
        response = client.chat.completions.create(
            model="glm-4-flash",
            messages=[{"role": "user", "content": system_prompt}],
            temperature=0.1,  # é™ä½æ¸©åº¦ä»¥æé«˜æ•°å­—å‡†ç¡®æ€§
            top_p=0.95,
            max_tokens=8192,
        )

        # è·å–å“åº”æ–‡æœ¬
        response_text = response.choices[0].message.content.strip()

        # å°è¯•æå–JSONï¼ˆå¯èƒ½è¢«markdownä»£ç å—åŒ…è£¹ï¼‰
        if response_text.startswith("```json"):
            response_text = response_text[7:]
        if response_text.startswith("```"):
            response_text = response_text[3:]
        if response_text.endswith("```"):
            response_text = response_text[:-3]
        response_text = response_text.strip()

        # å¦‚æœå“åº”è¢«æˆªæ–­ï¼Œå°è¯•ä¿®å¤
        if not response_text.endswith("]"):
            last_complete = response_text.rfind("},")
            if last_complete > 0:
                response_text = response_text[: last_complete + 1] + "\n]"

        # è§£æJSON
        result = json.loads(response_text)

        # éªŒè¯æ ¼å¼
        if not isinstance(result, list):
            raise ValueError("æ™ºè°±AIè¿”å›çš„ä¸æ˜¯JSONæ•°ç»„æ ¼å¼")

        # éªŒè¯æ¯ä¸ªå¯¹è¯å¯¹çš„æ ¼å¼
        for item in result:
            if not all(key in item for key in ["instruction", "input", "output"]):
                raise ValueError("å¯¹è¯å¯¹ç¼ºå°‘å¿…éœ€å­—æ®µ: instruction, input, output")

        return result

    except json.JSONDecodeError as e:
        raise Exception(f"è§£ææ™ºè°±AIå“åº”å¤±è´¥: {e}\nå“åº”å†…å®¹: {response_text}")
    except Exception as e:
        raise Exception(f"æ™ºè°±AI APIè°ƒç”¨å¤±è´¥: {e}")
